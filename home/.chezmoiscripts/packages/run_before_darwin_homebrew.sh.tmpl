{{- if .is_mac -}}

{{- $taps := list
    "hashicorp/tap"
-}}

{{- $brews := list
    "bat"
    "btop"
    "chezmoi"
    "coreutils"
    "curl"
    "direnv"
    "findutils"
    "fzf"
    "gh"
    "git-delta"
    "git"
    "gnu-sed"
    "gnu-tar"
    "gum"
    "htop"
    "jq"
    "mas"
    "moreutils"
    "openssl@3"
    "reattach-to-user-namespace"
    "ripgrep"
    "sesh"
    "shellcheck"
    "starship"
    "terminal-notifier"
    "tig"
    "tmux"
    "tree"
    "vim"
    "wget"
    "zoxide"
    "zsh-syntax-highlighting"
    "zsh"
-}}

{{- $casks := list
    "1password-cli"
    "claude-code"
    "font-hack"
    "ghostty"
    "google-chrome"
    "gpg-suite"
    "karabiner-elements"
-}}

{{- $mas_apps := dict -}}

{{- if .with_aws -}}
{{-   $brews = concat $brews (list "awscli") -}}
{{- end -}}

{{- if .with_docker -}}
{{-   $brews = concat $brews (list "ctop") -}}
{{-   $casks = concat $casks (list "docker-desktop") -}}
{{- end -}}

{{- if .with_golang -}}
{{-   $brews = concat $brews (list "go") -}}
{{- end -}}

{{- if .with_javascript -}}
{{-   $brews = concat $brews (list "nvm") -}}
{{- end -}}

{{- if .with_nomad -}}
{{-   $brews = concat $brews (list "hashicorp/tap/nomad") -}}
{{- end -}}

{{- if .with_php -}}
{{-   $brews = concat $brews (list "php") -}}
{{- end -}}

{{- if .with_rust -}}
{{-   $brews = concat $brews (list "rustup") -}}
{{- end -}}

{{- if .with_terraform -}}
{{-   $brews = concat $brews (list "hashicorp/tap/terraform") -}}
{{- end -}}

{{- if .project_eurosport -}}
{{-   $brews = concat $brews (list
        "gimme-aws-creds"
        "jira-cli"
    ) -}}
{{- end -}}

{{- if .user_veberarnaud -}}
{{-   $casks = concat $casks (list
        "adobe-creative-cloud"
        "caffeine"
        "chatgpt"
        "claude"
        "cursor"
        "discord"
        "insomnia"
        "istat-menus"
        "lasso-app"
        "nordvpn"
        "obsidian"
        "plaud"
        "slack"
        "studio-3t"
        "whatsapp"
        "zoom"
    ) -}}
{{-   $mas_apps = merge $mas_apps (dict
        "904280696" "Things 3"
    ) -}}
{{- end -}}

{{- if .has_elgato -}}
{{-   $casks = concat $casks (list
        "elgato-stream-deck"
        "elgato-wave-link"
    ) -}}
{{- end -}}

{{- if .has_insta360 -}}
{{-   $casks = concat $casks (list "insta360-link-controller") -}}
{{- end -}}

{{- if .has_scanner -}}
{{-   $casks = concat $casks (list "fujitsu-scansnap-home") -}}
{{- end -}}

{{- if .user_openclaw -}}
{{-   $brews = concat $brews (list "cmake" "ffmpeg" "openclaw-cli" "whisper-cpp") -}}
{{- end -}}

#!/bin/bash

set -euo pipefail

# Include common functions
{{ template "common.tmpl" . }}

# Error trap to show line numbers on failure
trap 'log_error "Error on line $LINENO. Installation failed."' ERR

{{ if .is_apple_silicon -}}
# Install Rosetta 2 if not present (required for x86_64 apps)
if ! arch -x86_64 /usr/bin/true 2>/dev/null; then
    log_info "Installing Rosetta 2..."
    softwareupdate --install-rosetta --agree-to-license
    log_success "Rosetta 2 installed"
else
    log_success "Rosetta 2 already installed"
fi

{{ end -}}
# Check if Homebrew is installed
if ! check_command brew; then
    log_error "Homebrew not found. Please install Homebrew first:"
    echo "   /bin/bash -c \"\$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\""
    exit 1
fi

export HOMEBREW_CASK_OPTS="--appdir=${HOME}/Applications --fontdir=${HOME}/Library/Fonts"
export HOMEBREW_NO_ANALYTICS=1
export HOMEBREW_NO_INSECURE_REDIRECT=1

log_info "Updating Homebrew..."
retry brew update

log_info "Upgrading existing packages..."
retry brew upgrade
retry brew upgrade --cask

log_info "Installing packages from Brewfile..."
brew bundle --file=/dev/stdin <<EOF
{{ range ($taps | sortAlpha | uniq) -}}
tap "{{ . }}"
{{ end -}}
{{ range ($brews | sortAlpha | uniq) -}}
brew "{{ . }}"
{{ end -}}
{{ range ($casks | sortAlpha | uniq) -}}
cask "{{ . }}"
{{ end -}}
{{ range (keys $mas_apps | sortAlpha) -}}
mas "{{ index $mas_apps . }}", id: {{ . }}
{{ end -}}
EOF

log_info "Installing 1password in /Applications (required for browser integration)..."
brew install --cask 1password --appdir=/Applications 2>/dev/null || true

log_info "Cleaning up..."
brew cleanup

log_success "Homebrew packages installation complete"

{{- end -}}
