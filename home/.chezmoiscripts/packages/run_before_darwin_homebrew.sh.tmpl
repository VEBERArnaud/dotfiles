{{- if .is_mac -}}

{{- $taps := list
    "hashicorp/tap"
-}}

{{- $brews := list
    "bat"
    "chezmoi"
    "coreutils"
    "curl"
    "direnv"
    "findutils"
    "fzf"
    "gh"
    "gimme-aws-creds"
    "git-delta"
    "git"
    "gnu-sed"
    "gnu-tar"
    "htop"
    "jq"
    "moreutils"
    "openssl@3"
    "reattach-to-user-namespace"
    "ripgrep"
    "sesh"
    "shellcheck"
    "starship"
    "tig"
    "tmux"
    "tree"
    "vim"
    "wget"
    "zoxide"
    "zsh-syntax-highlighting"
    "zsh"
-}}

{{- $casks := list
    "1password-cli"
    "adobe-creative-cloud"
    "azure-data-studio"
    "caffeine"
    "chatgpt"
    "claude"
    "cursor"
    "discord"
    "font-hack"
    "fujitsu-scansnap-home"
    "ghostty"
    "google-chrome"
    "gpg-suite"
    "insomnia"
    "insta360-link-controller"
    "istat-menus"
    "karabiner-elements"
    "lasso-app"
    "nordvpn"
    "obsidian"
    "slack"
    "studio-3t"
    "whatsapp"
    "zoom"
-}}

{{- if .with_aws -}}
{{-   $brews = concat $brews (list "awscli") -}}
{{- end -}}

{{- if .with_docker -}}
{{-   $casks = concat $casks (list "docker-desktop") -}}
{{- end -}}

{{- if .with_golang -}}
{{-   $brews = concat $brews (list "go") -}}
{{- end -}}

{{- if .with_javascript -}}
{{-   $brews = concat $brews (list "nvm") -}}
{{- end -}}

{{- if .with_php -}}
{{-   $brews = concat $brews (list "php") -}}
{{- end -}}

{{- if .with_rust -}}
{{-   $brews = concat $brews (list "rustup") -}}
{{- end -}}

{{- if .with_terraform -}}
{{-   $brews = concat $brews (list "hashicorp/tap/terraform") -}}
{{- end -}}

#!/bin/bash

set -euo pipefail

# Include common functions
{{ template "common.tmpl" . }}

# Error trap to show line numbers on failure
trap 'log_error "Error on line $LINENO. Installation failed."' ERR

{{ if .is_apple_silicon -}}
# Install Rosetta 2 if not present (required for x86_64 apps)
if ! arch -x86_64 /usr/bin/true 2>/dev/null; then
    log_info "Installing Rosetta 2..."
    softwareupdate --install-rosetta --agree-to-license
    log_success "Rosetta 2 installed"
else
    log_success "Rosetta 2 already installed"
fi

{{ end -}}
# Check if Homebrew is installed
if ! check_command brew; then
    log_error "Homebrew not found. Please install Homebrew first:"
    echo "   /bin/bash -c \"\$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\""
    exit 1
fi

export HOMEBREW_CASK_OPTS="--appdir=${HOME}/Applications --fontdir=${HOME}/Library/Fonts"
export HOMEBREW_NO_ANALYTICS=1
export HOMEBREW_NO_INSECURE_REDIRECT=1

log_info "Updating Homebrew..."
retry brew update

log_info "Upgrading existing packages..."
retry brew upgrade
retry brew upgrade --cask

log_info "Installing packages from Brewfile..."
brew bundle --file=/dev/stdin <<EOF
{{ range ($taps | sortAlpha | uniq) -}}
tap "{{ . }}"
{{ end -}}
{{ range ($brews | sortAlpha | uniq) -}}
brew "{{ . }}"
{{ end -}}
{{ range ($casks | sortAlpha | uniq) -}}
cask "{{ . }}"
{{ end -}}
EOF

log_info "Installing 1password in /Applications (required for browser integration)..."
brew install --cask 1password --appdir=/Applications 2>/dev/null || true

log_info "Cleaning up..."
brew cleanup

log_success "Homebrew packages installation complete"

{{- end -}}
