{{- if .is_mac -}}

{{- $taps := list
    "hashicorp/tap"
-}}

{{- $brews := list
    "chezmoi"
    "coreutils"
    "curl"
    "direnv"
    "findutils"
    "fzf"
    "gh"
    "gimme-aws-creds"
    "git-delta"
    "git"
    "gnu-sed"
    "gnu-tar"
    "htop"
    "jq"
    "moreutils"
    "openssl@3"
    "reattach-to-user-namespace"
    "ripgrep"
    "shellcheck"
    "starship"
    "tig"
    "tmux"
    "tree"
    "vim"
    "wget"
    "zoxide"
    "zsh-syntax-highlighting"
    "zsh"
-}}

{{- $casks := list
    "1password-cli"
    "adobe-creative-cloud"
    "azure-data-studio"
    "chatgpt"
    "claude"
    "cursor"
    "discord"
    "font-hack"
    "ghostty"
    "google-chrome"
    "gpg-suite"
    "insomnia"
    "insta360-link-controller"
    "lasso-app"
    "logi-options+"
    "nordvpn"
    "obsidian"
    "slack"
    "studio-3t"
    "whatsapp"
    "zoom"
-}}

{{- $nodes := list
    "lts/jod"
    "lts/krypton"
-}}

{{- if .with_aws -}}
{{-   $brews = concat $brews (list "awscli") -}}
{{- end -}}

{{- if .with_docker -}}
{{-   $casks = concat $casks (list "docker-desktop") -}}
{{- end -}}

{{- if .with_golang -}}
{{-   $brews = concat $brews (list "go") -}}
{{- end -}}

{{- if .with_javascript -}}
{{-   $brews = concat $brews (list "nvm") -}}
{{- end -}}

{{- if .with_php -}}
{{-   $brews = concat $brews (list "php") -}}
{{- end -}}

{{- if .with_terraform -}}
{{-   $brews = concat $brews (list "hashicorp/tap/terraform") -}}
{{- end -}}

#!/bin/bash

set -euo pipefail

# Include common functions
{{ template "common.tmpl" . }}

# Error trap to show line numbers on failure
trap 'log_error "Error on line $LINENO. Installation failed."' ERR

# Check if Homebrew is installed
if ! check_command brew; then
    log_error "Homebrew not found. Please install Homebrew first:"
    echo "   /bin/bash -c \"\$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\""
    exit 1
fi

export HOMEBREW_CASK_OPTS="--appdir=${HOME}/Applications --fontdir=${HOME}/Library/Fonts"
export HOMEBREW_NO_ANALYTICS=1
export HOMEBREW_NO_INSECURE_REDIRECT=1

log_info "Updating Homebrew..."
retry brew update

log_info "Upgrading existing packages..."
retry brew upgrade
retry brew upgrade --cask

log_info "Installing packages from Brewfile..."
brew bundle --file=/dev/stdin <<EOF
{{ range ($taps | sortAlpha | uniq) -}}
tap "{{ . }}"
{{ end -}}
{{ range ($brews | sortAlpha | uniq) -}}
brew "{{ . }}"
{{ end -}}
{{ range ($casks | sortAlpha | uniq) -}}
cask "{{ . }}"
{{ end -}}
EOF

log_info "Installing 1password in /Applications (required for browser integration)..."
brew install --cask 1password --appdir=/Applications 2>/dev/null || true

log_info "Cleaning up..."
brew cleanup

log_success "Homebrew packages installation complete"

{{ if .with_javascript -}}
# Initialize Homebrew environment to get HOMEBREW_PREFIX
{{ if stat "/opt/homebrew/bin/brew" -}}
eval "$(/opt/homebrew/bin/brew shellenv)"
{{ else if stat "/usr/local/bin/brew" -}}
eval "$(/usr/local/bin/brew shellenv)"
{{ end -}}

export NVM_DIR="$HOME/.nvm"

# Source NVM with proper error handling
if [ -s "${HOMEBREW_PREFIX}/opt/nvm/nvm.sh" ]; then
    source "${HOMEBREW_PREFIX}/opt/nvm/nvm.sh"
else
    log_error "NVM installation not found at ${HOMEBREW_PREFIX}/opt/nvm/nvm.sh"
    exit 1
fi

# Verify nvm command is available
if ! check_command nvm; then
    log_error "nvm command not available after sourcing. Installation may have failed."
    exit 1
fi

log_info "Installing Node.js LTS versions..."
{{   range ($nodes) -}}
if nvm ls "{{ . }}" &>/dev/null; then
    log_success "Node.js {{ . }} already installed"
else
    log_info "Installing Node.js {{ . }}..."
    retry nvm install "{{ . }}"
fi
{{   end -}}

log_info "Setting default Node.js version to {{ last $nodes }}..."
nvm alias default {{ last $nodes }}

log_success "Node.js installations complete"
{{- end -}}

{{- end -}}
