#!/bin/bash

set -euo pipefail

# VÃ©rifier si op est disponible
if ! command -v op &>/dev/null; then
    echo "âš ï¸  1Password CLI not found, skipping GPG key import"
    exit 0
fi

# VÃ©rifier si connectÃ© Ã  1Password
if ! op whoami &>/dev/null; then
    echo "âš ï¸  Not signed in to 1Password, skipping GPG key import"
    exit 0
fi

KEY_ID="7D934C83"

# VÃ©rifier si la clÃ© est dÃ©jÃ  importÃ©e
if gpg --list-secret-keys "$KEY_ID" &>/dev/null; then
    echo "âœ“ GPG key $KEY_ID already imported"
    exit 0
fi

echo "ðŸ” Importing GPG key from 1Password..."

# Extraire et importer la clÃ©
op document get GPG | gpg --import

# Configurer la confiance (ultimate trust pour sa propre clÃ©)
FINGERPRINT=$(gpg --fingerprint "$KEY_ID" 2>/dev/null | grep -A1 "pub " | tail -1 | tr -d ' ')
echo "${FINGERPRINT}:6:" | gpg --import-ownertrust

echo "âœ… GPG key imported successfully"
