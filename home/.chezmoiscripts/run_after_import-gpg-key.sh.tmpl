#!/bin/bash

set -euo pipefail

# V√©rifier si op est disponible
if ! command -v op &>/dev/null; then
    echo "‚ö†Ô∏è  1Password CLI not found, skipping GPG key import"
    exit 0
fi

# V√©rifier si connect√© √† 1Password
if ! op whoami &>/dev/null; then
    echo "‚ö†Ô∏è  Not signed in to 1Password, skipping GPG key import"
    exit 0
fi

KEY_ID="7D934C83"

# V√©rifier si la cl√© est d√©j√† import√©e
if gpg --list-secret-keys "$KEY_ID" &>/dev/null; then
    echo "‚úì GPG key $KEY_ID already imported"
    exit 0
fi

echo "üîê Importing GPG key from 1Password..."

# Extraire et importer la cl√©
op document get GPG | gpg --import

# Configurer la confiance (ultimate trust pour sa propre cl√©)
FINGERPRINT=$(gpg --fingerprint "$KEY_ID" 2>/dev/null | grep -A1 "pub " | tail -1 | tr -d ' ')
if [[ -z "$FINGERPRINT" ]]; then
    echo "‚ùå Failed to extract GPG fingerprint for key $KEY_ID"
    exit 1
fi
echo "${FINGERPRINT}:6:" | gpg --import-ownertrust

echo "‚úÖ GPG key imported successfully"
