{{- if .is_mac -}}
#!/bin/bash

set -euo pipefail

# Include common functions
{{ template "common.tmpl" . }}

# Check Claude CLI
if ! check_command claude; then
    log_warn "Claude Code CLI not found. Skipping MCP servers configuration."
    exit 0
fi

# Check npx (requires Node.js)
if ! check_command npx; then
    log_warn "npx not found (Node.js required). Skipping MCP servers configuration."
    exit 0
fi

# Check 1Password CLI for API keys
if ! check_command op; then
    log_warn "1Password CLI not found. Skipping MCP servers configuration."
    exit 0
fi

# Check if signed in to 1Password
if ! op whoami &>/dev/null; then
    log_warn "Not signed in to 1Password. Skipping MCP servers configuration."
    exit 0
fi

log_info "Configuring Claude MCP servers..."

# Check if MCP server is already installed
mcp_exists() {
    local name="$1"
    claude mcp list 2>/dev/null | grep -q "^${name}:"
}

# Add chrome-devtools MCP server
if mcp_exists "chrome-devtools"; then
    log_info "  MCP server chrome-devtools already configured"
else
    log_info "  Adding MCP server: chrome-devtools..."
    if claude mcp add "chrome-devtools" --scope user -- npx chrome-devtools-mcp@latest --executablePath "{{ .chezmoi.homeDir }}/Applications/Google Chrome.app/Contents/MacOS/Google Chrome" &>/dev/null; then
        log_success "  chrome-devtools added"
    else
        log_error "  Failed to add chrome-devtools"
    fi
fi

# Add context7 MCP server (requires API key from 1Password)
if mcp_exists "context7"; then
    log_info "  MCP server context7 already configured"
else
    CONTEXT7_API_KEY=$(op read "op://Personal/context7/API_KEY")
    log_info "  Adding MCP server: context7..."
    if claude mcp add "context7" --scope user -- npx -y @upstash/context7-mcp --api-key "${CONTEXT7_API_KEY}" &>/dev/null; then
        log_success "  context7 added"
    else
        log_error "  Failed to add context7"
    fi
fi

log_success "Claude MCP servers configuration complete"

{{- end -}}
