{{- if .is_mac -}}

{{- $taps := list
    "hashicorp/tap"
-}}

{{- $brews := list
    "chezmoi"
    "coreutils"
    "ctags"
    "curl"
    "diff-so-fancy"
    "direnv"
    "findutils"
    "fzf"
    "gh"
    "gimme-aws-creds"
    "git"
    "gnu-sed"
    "gnu-tar"
    "htop"
    "jq"
    "moreutils"
    "openssl@3"
    "reattach-to-user-namespace"
    "shellcheck"
    "the_platinum_searcher"
    "the_silver_searcher"
    "tig"
    "tmux"
    "tree"
    "vim"
    "wget"
    "z"
    "zsh"
    "zsh-syntax-highlighting"
-}}

{{- $casks := list
    "1password-cli"
    "cursor"
    "discord"
    "font-hack"
    "ghostty"
    "google-chrome"
    "gpg-suite"
    "lasso-app"
    "insomnia"
    "slack"
    "zoom"
-}}

{{- $nodes := list
    "lts/hydrogen"
    "lts/iron"
    "lts/jod"
    "lts/krypton"
-}}

{{- if .with_aws -}}
{{-   $brews = concat $brews (list "awscli") -}}
{{- end -}}

{{- if .with_docker -}}
{{-   $casks = concat $casks (list "docker-desktop") -}}
{{- end -}}

{{- if .with_golang -}}
{{-   $brews = concat $brews (list "go") -}}
{{- end -}}

{{- if .with_javascript -}}
{{-   $brews = concat $brews (list "nvm") -}}
{{- end -}}

{{- if .with_php -}}
{{-   $brews = concat $brews (list "php") -}}
{{- end -}}

{{- if .with_terraform -}}
{{-   $brews = concat $brews (list "hashicorp/tap/terraform") -}}
{{- end -}}

#!/bin/bash

set -eufo pipefail

# Error trap to show line numbers on failure
trap 'echo "âŒ Error on line $LINENO. Installation failed." >&2' ERR

# Check if Homebrew is installed
if ! command -v brew &>/dev/null; then
    echo "âŒ Homebrew not found. Please install Homebrew first:" >&2
    echo "   /bin/bash -c \"\$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\"" >&2
    exit 1
fi

# Retry function for network-dependent operations
retry() {
    local max_attempts=3
    local timeout=2
    local attempt=1
    local exit_code=0

    while [ $attempt -le $max_attempts ]; do
        if "$@"; then
            return 0
        else
            exit_code=$?
            if [ $attempt -lt $max_attempts ]; then
                echo "âš ï¸  Command failed (attempt $attempt/$max_attempts). Retrying in ${timeout}s..." >&2
                sleep $timeout
                attempt=$((attempt + 1))
                timeout=$((timeout * 2))
            else
                echo "âŒ Command failed after $max_attempts attempts." >&2
                return $exit_code
            fi
        fi
    done
}

export HOMEBREW_CASK_OPTS="--appdir=${HOME}/Applications --fontdir=${HOME}/Library/Fonts --no-binaries"
export HOMEBREW_NO_ANALYTICS=1
export HOMEBREW_NO_INSECURE_REDIRECT=1

echo "ğŸ”„ Updating Homebrew..."
retry brew update

echo "â¬†ï¸  Upgrading existing packages..."
retry brew upgrade
retry brew upgrade --cask

echo "ğŸ“¦ Installing packages from Brewfile..."
brew bundle --file=/dev/stdin <<EOF
{{ range ($taps | sortAlpha | uniq) -}}
tap "{{ . }}"
{{ end -}}
{{ range ($brews | sortAlpha | uniq) -}}
brew "{{ . }}"
{{ end -}}
{{ range ($casks | sortAlpha | uniq) -}}
cask "{{ . }}"
{{ end -}}
EOF

echo "ğŸ§¹ Cleaning up..."
brew cleanup

echo "âœ… Homebrew packages installation complete"

{{ if .with_javascript -}}
# Initialize Homebrew environment to get HOMEBREW_PREFIX
{{ if stat "/opt/homebrew/bin/brew" -}}
eval "$(/opt/homebrew/bin/brew shellenv)"
{{ else if stat "/usr/local/bin/brew" -}}
eval "$(/usr/local/bin/brew shellenv)"
{{ end -}}

export NVM_DIR="$HOME/.nvm"

# Source NVM with proper error handling
if [ -s "${HOMEBREW_PREFIX}/opt/nvm/nvm.sh" ]; then
    source "${HOMEBREW_PREFIX}/opt/nvm/nvm.sh"
else
    echo "âŒ NVM installation not found at ${HOMEBREW_PREFIX}/opt/nvm/nvm.sh" >&2
    exit 1
fi

# Verify nvm command is available
if ! command -v nvm &>/dev/null; then
    echo "âŒ nvm command not available after sourcing. Installation may have failed." >&2
    exit 1
fi

echo "ğŸ“¦ Installing Node.js LTS versions..."
{{   range ($nodes) -}}
if nvm ls "{{ . }}" &>/dev/null; then
    echo "âœ“ Node.js {{ . }} already installed"
else
    echo "ğŸ”„ Installing Node.js {{ . }}..."
    retry nvm install "{{ . }}"
fi
{{   end -}}

echo "âœ… Node.js installations complete"
{{- end -}}

{{- end -}}
