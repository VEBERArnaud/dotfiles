#!/usr/bin/env bash

set -euo pipefail

echo "üîç Verifying dotfiles installation..."

errors=0

# Check critical files exist
check_file() {
    if [[ -f "$1" ]]; then
        echo "‚úì $1 exists"
    else
        echo "‚úó $1 missing"
        errors=$((errors + 1))
    fi
}

echo ""
echo "üìÅ Checking critical files..."
check_file "${HOME}/.zshrc"
check_file "${HOME}/.vimrc"
check_file "${HOME}/.gitconfig"
check_file "${HOME}/.tmux.conf"
check_file "${HOME}/.config/starship.toml"

# Check essential commands are available
check_command() {
    if command -v "$1" &>/dev/null; then
        echo "‚úì $1 available"
    else
        echo "‚úó $1 not found"
        errors=$((errors + 1))
    fi
}

echo ""
echo "üîß Checking essential commands..."
check_command zsh
check_command vim
check_command tmux
check_command git
check_command starship

# Validate shell config syntax
echo ""
echo "üìù Validating configuration syntax..."

if zsh -n "${HOME}/.zshrc" 2>/dev/null; then
    echo "‚úì .zshrc syntax valid"
else
    echo "‚úó .zshrc has syntax errors"
    errors=$((errors + 1))
fi

if vim --noplugin -es -c 'quit' "${HOME}/.vimrc" 2>/dev/null; then
    echo "‚úì .vimrc syntax valid"
else
    echo "‚úó .vimrc has syntax errors"
    errors=$((errors + 1))
fi

# Summary
echo ""
if [[ $errors -eq 0 ]]; then
    echo "‚úÖ All verification checks passed!"
else
    echo "‚ö†Ô∏è  Verification completed with $errors error(s)"
    exit 1
fi
